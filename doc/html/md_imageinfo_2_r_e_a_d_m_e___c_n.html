<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EPUB Utilities: imageinfo</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">EPUB Utilities<span id="projectnumber">&#160;1.0.0-RC.1</span>
   </div>
   <div id="projectbrief">EPUB CLI Utilities</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">imageinfo</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>跨平台高性能的C++单个头文件库，在不加载/解码图片的情况下，获取图片文件类型和大小。</p>
<p>imageinfo 并不是通过扩展名来识别图片格式，而是通过文件头和文件格式特征来判断图片格式。</p>
<p>尽可能少的I/O次数！读取尽可能少的字节数！</p>
<p>部分测试图片文件来源于 <a href="https://github.com/image-size/image-size">image-size</a> ，感谢 <a href="https://github.com/netroy">@netroy</a></p>
<p>Rust 版本: <a href="https://github.com/xiaozhuai/imageinfo-rs">imageinfo-rs</a></p>
<p><a href="https://github.com/xiaozhuai/imageinfo/actions/workflows/linux.yml"><img src="https://github.com/xiaozhuai/imageinfo/actions/workflows/linux.yml/badge.svg" alt="linux" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/xiaozhuai/imageinfo/actions/workflows/macos.yml"><img src="https://github.com/xiaozhuai/imageinfo/actions/workflows/macos.yml/badge.svg" alt="macos" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/xiaozhuai/imageinfo/actions/workflows/windows-x64.yml"><img src="https://github.com/xiaozhuai/imageinfo/actions/workflows/windows-x64.yml/badge.svg" alt="windows-x64" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/xiaozhuai/imageinfo/actions/workflows/windows-x86.yml"><img src="https://github.com/xiaozhuai/imageinfo/actions/workflows/windows-x86.yml/badge.svg" alt="windows-x86" style="pointer-events: none;" class="inline"/></a></p>
<h1>支持格式</h1>
<ul>
<li>[x] avif</li>
<li>[x] bmp</li>
<li>[x] cur</li>
<li>[x] dds</li>
<li>[x] gif</li>
<li>[x] hdr (pic)</li>
<li>[x] heic (heif)</li>
<li>[x] icns</li>
<li>[x] ico</li>
<li>[x] jp2</li>
<li>[x] jpeg (jpg)</li>
<li>[x] jpx</li>
<li>[x] ktx</li>
<li>[x] png</li>
<li>[x] psd</li>
<li>[x] qoi</li>
<li>[ ] svg</li>
<li>[x] tga</li>
<li>[x] tiff (tif)</li>
<li>[x] webp</li>
<li>[ ] 更多...</li>
</ul>
<h1>Vcpkg</h1>
<p>imageinfo 可以通过 <a href="https://github.com/microsoft/vcpkg">vcpkg</a> 安装</p>
<div class="fragment"><div class="line">vcpgk install imageinfo</div>
</div><!-- fragment --><h1>构建 &amp; 测试</h1>
<h2>Linux &amp; MacOS</h2>
<div class="fragment"><div class="line">cmake -B build .</div>
<div class="line">cmake --build build -- all</div>
<div class="line">cmake --build build -- check</div>
</div><!-- fragment --><h2>Windows</h2>
<p>打开 Visual Studio Command Prompt 并执行下面的命令</p>
<div class="fragment"><div class="line">cmake -G &quot;NMake Makefiles&quot; -B build .</div>
<div class="line">cmake --build build -- all</div>
<div class="line">cmake --build build -- check</div>
</div><!-- fragment --><h1>用法</h1>
<h2>最简DEMO代码</h2>
<div class="fragment"><div class="line"><span class="keyword">auto</span> imageInfo = getImageInfo&lt;IIFilePathReader&gt;(<span class="stringliteral">&quot;images/valid/jpg/sample.jpg&quot;</span>);</div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;File: &quot;</span> &lt;&lt; file &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;  - Error    : &quot;</span> &lt;&lt; imageInfo.getErrorMsg() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;  - Width    : &quot;</span> &lt;&lt; imageInfo.getWidth() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;  - Height   : &quot;</span> &lt;&lt; imageInfo.getHeight() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;  - Format   : &quot;</span> &lt;&lt; imageInfo.getFormat() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;  - Ext      : &quot;</span> &lt;&lt; imageInfo.getExt() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;  - Full Ext : &quot;</span> &lt;&lt; imageInfo.getFullExt() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">std::cout &lt;&lt; <span class="stringliteral">&quot;  - Mimetype : &quot;</span> &lt;&lt; imageInfo.getMimetype() &lt;&lt; <span class="stringliteral">&quot;\n\n&quot;</span>;</div>
</div><!-- fragment --><p>可以使用 <code><a class="el" href="class_i_i_file_path_reader.html">IIFilePathReader</a></code> 然后直接传入文件路径,</p>
<p>不同类型可以使用不同的 Reader, 如 <code><a class="el" href="class_i_i_file_reader.html">IIFileReader</a></code>, <code><a class="el" href="class_i_i_file_stream_reader.html">IIFileStreamReader</a></code>, <code><a class="el" href="class_i_i_raw_data_reader.html">IIRawDataReader</a></code></p>
<div class="fragment"><div class="line">FILE *file = fopen(<span class="stringliteral">&quot;images/valid/jpg/sample.jpg&quot;</span>, <span class="stringliteral">&quot;rb&quot;</span>);</div>
<div class="line"><span class="keyword">auto</span> imageInfo = getImageInfo&lt;IIFileReader&gt;(file);</div>
<div class="line">fclose(file);</div>
</div><!-- fragment --><div class="fragment"><div class="line">std::ifstream file(<span class="stringliteral">&quot;images/valid/jpg/sample.jpg&quot;</span>, std::ios::in);</div>
<div class="line"><span class="keyword">auto</span> imageInfo = getImageInfo&lt;IIFileStreamReader&gt;(file);</div>
<div class="line">file.close();</div>
</div><!-- fragment --><div class="fragment"><div class="line"><span class="comment">// 假设已经得到了 data 和 size</span></div>
<div class="line"><span class="comment">// void *data;</span></div>
<div class="line"><span class="comment">// size_t size;</span></div>
<div class="line"><span class="keyword">auto</span> imageInfo = getImageInfo&lt;IIRawDataReader&gt;(<a class="code hl_struct" href="struct_i_i_raw_data.html">IIRawData</a>(data, <a class="code hl_struct" href="structgeom_1_1size.html">size</a>));</div>
<div class="ttc" id="astruct_i_i_raw_data_html"><div class="ttname"><a href="struct_i_i_raw_data.html">IIRawData</a></div><div class="ttdef"><b>Definition</b> imageinfo.hpp:199</div></div>
<div class="ttc" id="astructgeom_1_1size_html"><div class="ttname"><a href="structgeom_1_1size.html">::size</a></div><div class="ttdef"><b>Definition</b> comic.cpp:51</div></div>
</div><!-- fragment --><p>如果你事先知道一个文件大概率是JPEG格式, 你可以提供额外的 <code>likely format</code> 参数来提升性能;</p>
<div class="fragment"><div class="line"><span class="keyword">auto</span> imageInfo = getImageInfo&lt;IIFilePathReader&gt;(<span class="stringliteral">&quot;images/valid/jpg/sample.jpg&quot;</span>, <a class="code hl_enumvalue" href="imageinfo_8hpp.html#ac3deae66dcf51c73d21f8363913b371aac21d127e879446a2b8a484b2fd9d8490">II_FORMAT_JPEG</a>);</div>
<div class="ttc" id="aimageinfo_8hpp_html_ac3deae66dcf51c73d21f8363913b371aac21d127e879446a2b8a484b2fd9d8490"><div class="ttname"><a href="imageinfo_8hpp.html#ac3deae66dcf51c73d21f8363913b371aac21d127e879446a2b8a484b2fd9d8490">II_FORMAT_JPEG</a></div><div class="ttdeci">@ II_FORMAT_JPEG</div><div class="ttdef"><b>Definition</b> imageinfo.hpp:84</div></div>
</div><!-- fragment --><h2>自定义Reader</h2>
<p>首先，来看一下 <code><a class="el" href="class_i_i_file_reader.html">IIFileReader</a></code>, 要做的只是定义一个类，然后实现 <code>size</code> 和 <code>read</code> 方法。(非override)</p>
<div class="fragment"><div class="line"><span class="keyword">class </span><a class="code hl_class" href="class_i_i_file_reader.html">IIFileReader</a> {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">explicit</span> <a class="code hl_class" href="class_i_i_file_reader.html">IIFileReader</a>(FILE *file) : <a class="code hl_variable" href="class_i_i_file_reader.html#a20f901664b9cab3bf7d4d98e947850a1">m_file</a>(file) {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">inline</span> <span class="keywordtype">size_t</span> <a class="code hl_function" href="class_i_i_file_reader.html#aebce3ab916f6757608359545afc85cc4">size</a>() {</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code hl_variable" href="class_i_i_file_reader.html#a20f901664b9cab3bf7d4d98e947850a1">m_file</a> != <span class="keyword">nullptr</span>) {</div>
<div class="line">            fseek(<a class="code hl_variable" href="class_i_i_file_reader.html#a20f901664b9cab3bf7d4d98e947850a1">m_file</a>, 0, SEEK_END);</div>
<div class="line">            <span class="keywordflow">return</span> ftell(<a class="code hl_variable" href="class_i_i_file_reader.html#a20f901664b9cab3bf7d4d98e947850a1">m_file</a>);</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            <span class="keywordflow">return</span> 0;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code hl_function" href="class_i_i_file_reader.html#af4affc1bc1f40885e67d38a889f43437">read</a>(<span class="keywordtype">void</span> *buf, off_t offset, <span class="keywordtype">size_t</span> <a class="code hl_struct" href="structgeom_1_1size.html">size</a>) {</div>
<div class="line">        fseek(<a class="code hl_variable" href="class_i_i_file_reader.html#a20f901664b9cab3bf7d4d98e947850a1">m_file</a>, offset, SEEK_SET);</div>
<div class="line">        fread(buf, 1, <a class="code hl_struct" href="structgeom_1_1size.html">size</a>, <a class="code hl_variable" href="class_i_i_file_reader.html#a20f901664b9cab3bf7d4d98e947850a1">m_file</a>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    FILE *<a class="code hl_variable" href="class_i_i_file_reader.html#a20f901664b9cab3bf7d4d98e947850a1">m_file</a> = <span class="keyword">nullptr</span>;</div>
<div class="line">};</div>
<div class="ttc" id="aclass_i_i_file_reader_html"><div class="ttname"><a href="class_i_i_file_reader.html">IIFileReader</a></div><div class="ttdef"><b>Definition</b> imageinfo.hpp:125</div></div>
<div class="ttc" id="aclass_i_i_file_reader_html_a20f901664b9cab3bf7d4d98e947850a1"><div class="ttname"><a href="class_i_i_file_reader.html#a20f901664b9cab3bf7d4d98e947850a1">IIFileReader::m_file</a></div><div class="ttdeci">FILE * m_file</div><div class="ttdef"><b>Definition</b> imageinfo.hpp:144</div></div>
<div class="ttc" id="aclass_i_i_file_reader_html_aebce3ab916f6757608359545afc85cc4"><div class="ttname"><a href="class_i_i_file_reader.html#aebce3ab916f6757608359545afc85cc4">IIFileReader::size</a></div><div class="ttdeci">size_t size()</div><div class="ttdef"><b>Definition</b> imageinfo.hpp:129</div></div>
<div class="ttc" id="aclass_i_i_file_reader_html_af4affc1bc1f40885e67d38a889f43437"><div class="ttname"><a href="class_i_i_file_reader.html#af4affc1bc1f40885e67d38a889f43437">IIFileReader::read</a></div><div class="ttdeci">void read(void *buf, off_t offset, size_t size)</div><div class="ttdef"><b>Definition</b> imageinfo.hpp:138</div></div>
</div><!-- fragment --><p>然后，让我们来尝试实现一个Android assets文件的Reader</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>IIAndroidAssetFileReader {</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">explicit</span> IIAndroidAssetFileReader(AAsset *file) : m_file(file) {}</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">inline</span> <span class="keywordtype">size_t</span> <a class="code hl_struct" href="structgeom_1_1size.html">size</a>() {</div>
<div class="line">        <span class="keywordflow">if</span> (m_file != <span class="keyword">nullptr</span>) {</div>
<div class="line">            <span class="keywordflow">return</span> AAsset_getLength(m_file);</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            <span class="keywordflow">return</span> 0;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">inline</span> <span class="keywordtype">void</span> read(<span class="keywordtype">void</span> *buf, off_t offset, <span class="keywordtype">size_t</span> <a class="code hl_struct" href="structgeom_1_1size.html">size</a>) {</div>
<div class="line">        AAsset_seek(m_file, offset, SEEK_SET);</div>
<div class="line">        AAsset_read(m_file, buf, <a class="code hl_struct" href="structgeom_1_1size.html">size</a>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    AAsset *m_file = <span class="keyword">nullptr</span>;</div>
<div class="line">};</div>
</div><!-- fragment --><div class="fragment"><div class="line"><span class="comment">// 假设已经得到了 AAssetManager</span></div>
<div class="line"><span class="comment">// AAssetManager *manager;</span></div>
<div class="line"><span class="comment">// 以 AASSET_MODE_RANDOM 模式打开以支持双向seek</span></div>
<div class="line">AAsset *file = AAssetManager_open(manager, <span class="stringliteral">&quot;test.png&quot;</span>, AASSET_MODE_RANDOM);</div>
<div class="line"><span class="keyword">auto</span> imageInfo = getImageInfo&lt;IIAndroidAssetFileReader&gt;(file);</div>
<div class="line">AAsset_close(file);</div>
</div><!-- fragment --><p>很简单不是吗？</p>
<p>请不要吝啬你的Star : ) </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
